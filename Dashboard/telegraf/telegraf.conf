# ===================================================================
# BUMBLEBEE WIRELESS POWER TRANSFER MONITORING SYSTEM
# Telegraf Configuration - MQTT to InfluxDB Bridge
# ===================================================================

[global_tags]
  system = "bumblebee"
  environment = "production"

[agent]
  interval = "1s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "1s"
  flush_jitter = "0s"
  precision = "1ms"
  hostname = "bumblebee-telegraf"
  omit_hostname = false

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# -------------------------------------------------------------------
# MQTT Consumer - Subscribe to Dynamic Data
# -------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["bumblebee/+/dynamic"]
  qos = 1
  client_id = "telegraf_dynamic"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "bumblebee_dynamic"
    
    ## Extract unit_id as a tag
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "unit_id"
    
    ## TX fields (nested under "tx")
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.mac"
      rename = "tx_mac"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.id"
      rename = "tx_id"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.status"
      rename = "tx_status"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.voltage"
      rename = "tx_voltage"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.current"
      rename = "tx_current"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.temp1"
      rename = "tx_temp1"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.temp2"
      rename = "tx_temp2"
      type = "float"
    
    ## RX fields (nested under "rx")
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.mac"
      rename = "rx_mac"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.id"
      rename = "rx_id"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.status"
      rename = "rx_status"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.voltage"
      rename = "rx_voltage"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.current"
      rename = "rx_current"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.temp1"
      rename = "rx_temp1"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.temp2"
      rename = "rx_temp2"
      type = "float"

# -------------------------------------------------------------------
# MQTT Consumer - Subscribe to Alert Data
# -------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["bumblebee/+/alerts"]
  qos = 1
  client_id = "telegraf_alerts"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "bumblebee_alerts"
    
    ## Extract unit_id as a tag
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "unit_id"
    
    ## TX Alert fields (nested under "tx")
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.mac"
      rename = "tx_mac"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.id"
      rename = "tx_id"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.overtemperature"
      rename = "tx_overtemperature"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.overcurrent"
      rename = "tx_overcurrent"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.overvoltage"
      rename = "tx_overvoltage"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tx.fod"
      rename = "tx_fod"
      type = "bool"
    
    ## RX Alert fields (nested under "rx")
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.mac"
      rename = "rx_mac"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.id"
      rename = "rx_id"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.overtemperature"
      rename = "rx_overtemperature"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.overcurrent"
      rename = "rx_overcurrent"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.overvoltage"
      rename = "rx_overvoltage"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "rx.fully_charged"
      rename = "rx_fully_charged"
      type = "bool"

###############################################################################
#                          PROCESSOR PLUGINS                                  #
###############################################################################

# -------------------------------------------------------------------
# Starlark Processor - Calculate Power and Efficiency
# -------------------------------------------------------------------
[[processors.starlark]]
  namepass = ["bumblebee_dynamic"]
  source = '''
def apply(metric):
    # Extract TX data (now they exist as flat fields!)
    tx_voltage = metric.fields.get("tx_voltage", 0.0)
    tx_current = metric.fields.get("tx_current", 0.0)
    tx_temp1 = metric.fields.get("tx_temp1", 0.0)
    tx_temp2 = metric.fields.get("tx_temp2", 0.0)
    
    # Extract RX data
    rx_voltage = metric.fields.get("rx_voltage", 0.0)
    rx_current = metric.fields.get("rx_current", 0.0)
    rx_temp1 = metric.fields.get("rx_temp1", 0.0)
    rx_temp2 = metric.fields.get("rx_temp2", 0.0)
    
    # Calculate TX Power (W)
    tx_power = tx_voltage * tx_current
    metric.fields["tx_power"] = tx_power
    
    # Calculate RX Power (W)
    rx_power = rx_voltage * rx_current
    metric.fields["rx_power"] = rx_power
    
    # Calculate Efficiency (%)
    if tx_power > 0:
        efficiency = (rx_power / tx_power) * 100.0
        metric.fields["efficiency"] = efficiency
    else:
        metric.fields["efficiency"] = 0.0
    
    # Calculate max temperature for TX
    tx_temp_max = max(tx_temp1, tx_temp2)
    metric.fields["tx_temp_max"] = tx_temp_max
    
    # Calculate max temperature for RX
    rx_temp_max = max(rx_temp1, rx_temp2)
    metric.fields["rx_temp_max"] = rx_temp_max
    
    return metric
'''

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

# -------------------------------------------------------------------
# Output to InfluxDB v2
# -------------------------------------------------------------------
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "bumblebee-super-secret-token"
  organization = "bumblebee"
  bucket = "sensor_data"
  timeout = "5s"

# -------------------------------------------------------------------
# Debug Output (Optional - Comment out in production)
# -------------------------------------------------------------------
[[outputs.file]]
  files = ["stdout"]
  data_format = "influx"